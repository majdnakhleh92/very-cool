local queue_on_teleport = queue_on_teleport
local StarterGui = game:GetService("StarterGui")
local webhookUtil = loadstring(game:HttpGet("https://pastebin.com/raw/fpkbJgyq"))()
local brainrotImages = loadstring(game:HttpGet("https://pastebin.com/raw/i0AJf9G9"))()
local Service = game:GetService("HttpService")
local hubName = "Garof ServerHopper"
local Testing = false

local old
old = hookfunction(debug.info, newcclosure(function(l, w, ...)
	local r = old(l, w, ...)
	if type(l) == "number" and w == "s" and l == 3 then
		if r == "[C]" or (type(r) == "string" and not r:find(".", 1, true)) then
			return "ReplicatedStorage.Controllers.EventController"
		end
	end
	return r
end))

local Syncronizer = require(game:GetService("ReplicatedStorage").Packages:WaitForChild("Synchronizer"))
local AnimalsShared = require(game.ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Animals"))

if started and not Testing then
	local bindable = Instance.new("BindableFunction")
	bindable.OnInvoke = function(button)
		if button == "Yes" then
			game["Teleport Service"]:Teleport(game.PlaceId, game.Players.LocalPlayer)
		end
	end
	StarterGui:SetCore("SendNotification", {
		Title = "The script is already running!",
		Text = "Teleport to start?",
		Duration = 5,
		Button1 = "Yes",
		Button2 = "No",
		Callback = bindable
	})
	return
end
pcall(function() getgenv().started = true end)

game.Players.LocalPlayer.OnTeleport:Connect(function(state)
	if state ~= Enum.TeleportState.Started and state ~= Enum.TeleportState.InProgress then return end
	queue_on_teleport([[
        repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer and game.Players.LocalPlayer.Character
        task.wait(2)
        local url = "https://raw.githubusercontent.com/majdnakhleh92/very-cool/refs/heads/main/bottington"
        local StarterGui = game:GetService("StarterGui")
        local SoundService = game:GetService("SoundService")
        local webhookUtil = loadstring(game:HttpGet("https://pastebin.com/raw/fpkbJgyq"))()
        local func, err = pcall(function() loadstring(game:HttpGet(url))() end)
        if not func then
            print(err)
            StarterGui:SetCore("SendNotification", {Title = "SOMETHING WENT WRONG!!!", Text = "somethingwentwrong", Duration = 5})
            local sound = Instance.new("Sound")
            sound.SoundId = "rbxassetid://4881487887"
            sound.Volume = 0.5
            sound.Parent = SoundService
            sound:Play()
            getgenv().started = false
            local msg = ""
            if err == 'http error occured: "HTTP/1.1 429 Too Many Requests"' then msg = "Lower the teleport delay!" end
            local myMessage = webhookUtil.createMessage({
                Url = "https://discord.com/api/webhooks/1317498619770703893/jyiYAeI_GvB1Nw4vcbZNmxyXaReXg2vRiKDxy0txviujU3o_71ec5FAsyxDOEgBGkXoh",
                username = "Script Logs",
                content = msg
            })
            myMessage.addEmbed("error occured", 0x57F287, err, nil, nil)
            myMessage.sendMessage()
        end
    ]])
end)

local Settings = {}
local Bots = {}

makefolder(hubName)

function SaveSettings()
	writefile(hubName .. "\\configName.cfg", Service:JSONEncode(Settings))
end
function LoadSettings()
	if isfile(hubName .. "\\configName.cfg") then
		Settings = Service:JSONDecode(readfile(hubName .. "\\configName.cfg"))
	end
end
function SaveBots()
	writefile(hubName .. "\\Bots.cfg", Service:JSONEncode(Bots))
end
function LoadBots()
	if isfile(hubName .. "\\Bots.cfg") then
		Bots = Service:JSONDecode(readfile(hubName .. "\\Bots.cfg"))
	end
end

LoadSettings()
LoadBots()

function ResetSettings()
	Settings["Server Count"] = 0
	writefile(hubName .. "\\configName.cfg", Service:JSONEncode(Settings))
end

local function GetBrainrotUrl(name)
	return brainrotImages[name] or nil
end

local blacklist = Settings["Blacklist"] or {"La Grande Combinasion", "Los Nooo My Hotspotsitos", "Bunito Bunito Spinito", "Horegini Boom", "Lucky Block", "Giftini Spyderini", "Santa Hotspot", "Naughty Naughty", "Los Cucarachas", "La Cucaracha", "Pot Hotspot", "Los 25", "Ho Ho Ho Sahur", "To to to Sahur", "Chimnino", "Graipuss Medussi", "Rocco Disco", "Triplito Tralaleritos", "La Vacca Prese Presente", "Los Tralaleritos", "Guerriro Digitale", "Noo my Present", "Las Tralaleritas", "Los Tortus", "Job Job Job Sahur", "Los Burritos", "Los Jobcitos", "Burrito Bandito", "Quesadilla Crocodila", "Los Quesadillas", "Tung Tung Tung Sahur", "Cuadramat and Pakrahmatmamat", "List List List Sahur", "Chicleteirina Bicicleteirina"}

local function formatGen(n)
	if n >= 1e12 then return string.format("%.1ft", n / 1e12)
	elseif n >= 1e9 then return string.format("%.1fb", n / 1e9)
	elseif n >= 1e6 then return string.format("%.1fm", n / 1e6)
	elseif n >= 1e3 then return string.format("%.1fk", n / 1e3)
	else return tostring(n) end
end

local function CheckCurrency(minimum)
	local best = nil
	local bestGen = -math.huge
	local minimumMet = {}
	local player = game.Players.LocalPlayer

	for _, plotModel in workspace.Plots:GetChildren() do
		local plot = Syncronizer:Get(plotModel.Name)
		if not plot then continue end

		local owner = plot:Get("Owner")
		if not owner then continue end
		if typeof(owner) == "Instance" and owner:IsA("Player") and owner.UserId == player.UserId then continue end

		local animals = plot:Get("AnimalList")
		if not animals then continue end

		for _, animal in animals do
			if animal == "Empty" or typeof(animal) == "string" then continue end
			local displayName = animal.DisplayName or animal.Index
			if table.find(blacklist, displayName) then continue end

			local gen = AnimalsShared:GetGeneration(animal.Index, animal.Mutation, animal.Traits, nil)

			if gen > bestGen then
				bestGen = gen
				best = { uuid = animal.UUID, displayName = displayName, gen = gen }
			end
			if gen >= minimum then
				table.insert(minimumMet, { uuid = animal.UUID, displayName = displayName, gen = gen })
			end
		end
	end

	if not best or bestGen == -math.huge then
		return false, nil, nil, {}
	end

	table.sort(minimumMet, function(a, b) return a.gen > b.gen end)

	local temp = {}
	for _, v in minimumMet do
		temp[v.uuid] = v.displayName .. " (" .. formatGen(v.gen) .. ")"
	end

	return bestGen >= minimum, best, best.uuid, temp
end

local function DiscordNotification(best, temp)
	local anonymous = game.Players.LocalPlayer.Name
	if Settings["anonymity"] == true then anonymous = "anonymous" end

	local description = "**⚠︎ Other Brainrots**\n```" .. table.concat(temp, "\n") .. "```"

	local myMessage = webhookUtil.createMessage({
		Url = "https://discord.com/api/webhooks/1317498619770703893/jyiYAeI_GvB1Nw4vcbZNmxyXaReXg2vRiKDxy0txviujU3o_71ec5FAsyxDOEgBGkXoh",
		username = "Script Logs",
		content = "A good server found by: " .. anonymous
	})

	local embed1 = myMessage.addEmbed(
		best.displayName .. " " .. formatGen(best.gen),
		Settings["embedColor"] or 0x57F287,
		description,
		nil,
		GetBrainrotUrl(best.displayName)
	)

	if anonymous ~= "anonymous" then
		embed1.addField("Server Id", game.JobId, false)
	end

	myMessage.sendMessage()
	ResetSettings()
end

local function CheckIfClaimed()
	local JobId = game.JobId
	local player = game.Players.LocalPlayer
	if next(Bots) == nil then return true end
	for bot, server in Bots do
		if bot == player.Name and server == JobId then return true end
		if server == JobId then return false end
	end
	return true
end

local function CheckIfProccessed(uuid, Table)
	if Table[uuid] and (tick() - Table[uuid]) < 160 then return true end
	return false
end

local function Serverhop()
	local Tried
	local HttpService, TeleportService, CoreGui = game:GetService("HttpService"), game:GetService("TeleportService"), game:GetService("CoreGui")
	local RemoveErrorPrompts = Settings["RemoveErrorPrompts"] or true
	local IterationSpeed = Settings["ServerhopSpeed"] or 0.30
	local ExcludefullServers = Settings["ExcludefullServers"] or false
	local SaveTeleportAttempts = Settings["SaveTeleportAttempts"] or false
	local API = Settings["API"] or "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?limit=100"

	if Testing then return end

	local function EncodeToFile(JSONString)
		local success, JSONData = pcall(function() return HttpService:JSONDecode(JSONString) end)
		if success and JSONData.data then
			JSONData.gameId = game.PlaceId
			local ok, encoded = pcall(function() return HttpService:JSONEncode(JSONData) end)
			if ok then writefile("Servers.JSON", encoded) else warn("Failed to encode JSON") return nil end
		else warn("Failed to decode JSONData") return nil end
		return JSONData
	end

	local function NextCursor(ep)
		return game:HttpGet(API .. "&excludeFullGames=" .. tostring(ExcludefullServers) .. ((ep and "&cursor=" .. ep) or ""))
	end

	local function StartTeleport()
		Tried = true
		local JSONData = EncodeToFile(readfile("Servers.JSON"))
		if not JSONData then writefile("Servers.JSON", game:HttpGet(API)) StartTeleport() end
		for i = 0, 99 do
			if #JSONData.data <= 1 then
				EncodeToFile(NextCursor(JSONData.nextPageCursor))
				TeleportService:Teleport(game.PlaceId, game.Players.LocalPlayer)
			end
			if JSONData.data[i] then
				local JobId = JSONData.data[i].id
				table.remove(JSONData.data, i)
				local ok, encoded = pcall(function() return HttpService:JSONEncode(JSONData) end)
				writefile("Servers.JSON", encoded)
				if SaveTeleportAttempts then appendfile("Attempts.txt", JobId .. "\n") end
				TeleportService:TeleportToPlaceInstance(game.PlaceId, JobId, game.Players.LocalPlayer)
				task.wait(IterationSpeed)
			end
		end
	end

	local function SetMainPage()
		writefile("Servers.JSON", game:HttpGet(API))
		StartTeleport()
	end

	if RemoveErrorPrompts then
		local RG = CoreGui:FindFirstChild("RobloxGui")
		local M = RG and RG:FindFirstChild("Modules")
		local EP = M and M:FindFirstChild("ErrorPrompt")
		if EP then EP:Destroy() end
		local RPG = CoreGui:FindFirstChild("RobloxPromptGui")
		if RPG then RPG:Destroy() end
	end

	if isfile("Servers.JSON") then
		local success, JSONData = pcall(function() return HttpService:JSONDecode(readfile("Servers.JSON")) end)
		if success and JSONData then
			if JSONData.gameId ~= game.PlaceId then warn("Game mismatch, remaking cache") SetMainPage() end
			if JSONData.data and #JSONData.data >= 1 then
				StartTeleport()
			else
				if success and JSONData.nextPageCursor then
					EncodeToFile(NextCursor(JSONData.nextPageCursor))
					StartTeleport()
				else
					SetMainPage()
				end
			end
		else
			SetMainPage()
		end
	else
		SetMainPage()
	end

	if Tried then
		print("yaaaaaaaaaaaaaaaaaaaaa")
		Serverhop()
	end
end

local minimum = tonumber(Settings["MoneyPerSecond"]) or 10_000_000
local Proccessed = {}

while task.wait(math.random(2, 4)) do
	LoadBots()
	local player = game.Players.LocalPlayer
	local Claimed = CheckIfClaimed()

	if Claimed then
		Bots[player.Name] = game.JobId
		SaveBots()

		local meetsMinimum, best, bestUUID, temp = CheckCurrency(minimum)
		if meetsMinimum then
			local tbl = {}
			for i, v in temp do

				local proccessed = CheckIfProccessed(i, Proccessed)
				if proccessed then continue end
				table.insert(tbl, v)
				Proccessed[i] = tick()
			end
			if next(tbl) == nil then continue end
			for i, v in tbl do
				print(i .. ": " .. v)
			end

			DiscordNotification(best, tbl)
		end
	else
		Bots[player.Name] = nil
		SaveBots()
		Serverhop()
	end
end
